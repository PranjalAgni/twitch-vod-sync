<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Twich VOD Sync</title>
  </head>
  <body>
    <form id="picker">
      <input type="text" id="picker-video" placeholder="Twitch video ID">
      <input type="submit" value="Watch">
    </form>
    <div id="player" style="display: none; position: fixed; top: 0; left: 0; bottom: 20px; right: 0;"></div>
    <div id="timestamp" style="position: absolute; bottom: 0; left: 0; right: 0; text-align: center;"></div>
    <script src= "https://player.twitch.tv/js/embed/v1.js"></script>
    <script>
function npad(num, size) {
  var s = "" + num;
  while(s.length < size) {
    s = "0" + s;
  }
  return s;
}

// Get an access token for API access
var twitch_client_id = "r69vc9claq1m3n960hrkuszot4nx54";
var access_token = null;
var match = window.location.hash.match(/#access_token=([^&]+)/);
if(match && match[1]) {
  access_token = match[1];
} else {
  window.location = "https://id.twitch.tv/oauth2/authorize?client_id=" + twitch_client_id + "&redirect_uri=https://twitch-sync.remram.fr/&response_type=token&scope=";
}

// Wait for the user to enter a video
document.getElementById("picker").addEventListener("submit", function(evt) {
  evt.preventDefault();
  document.getElementById("picker").style.display = "none";
  showVideo(parseInt(document.getElementById("picker-video").value));
  return false;
});

var interval = null;

function showVideo(video) {
  console.log("video: ", video);
  document.getElementById("player").style.display = "block";

  // Get video information from API
  var videoDate = null;

  fetch(
    "https://api.twitch.tv/helix/videos?id=" + video,
    {
      headers: {
        "Client-ID": twitch_client_id,
        "Authorization": "Bearer " + access_token,
      },
    },
  ).then(function(response) {
    if(response.status == 200) {
      response.json().then(function(json) {
        console.log("Got video date: ", json.data[0].created_at);
        videoDate = new Date(json.data[0].created_at);
      });
    }
  });

  // Create player
  var player = new Twitch.Player("player", {
    width: "100%",
    height: "100%",
    video: video,
  });

  // Update timestamp when needed
  function updateTimestamp() {
    if(!videoDate) {
      return;
    }
    var timestamp = videoDate;
    timestamp = timestamp.getTime();
    timestamp += player.getCurrentTime() * 1000;
    timestamp = new Date(timestamp);
    document.getElementById("timestamp").innerText = (
      timestamp.getFullYear() + "-"
      + npad(timestamp.getMonth() + 1, 2) + "-"
      + npad(timestamp.getDate(), 2) + " "
      + npad(timestamp.getHours(), 2) + ":"
      + npad(timestamp.getMinutes(), 2) + ":"
      + npad(timestamp.getSeconds(), 2)
    );
  }
  player.addEventListener(Twitch.Player.READY, updateTimestamp);
  player.addEventListener(Twitch.Player.PLAYING, updateTimestamp);
  player.addEventListener(Twitch.Player.PAUSE, updateTimestamp);
  if(interval) {
    clearInterval(interval);
  }
  interval = setInterval(updateTimestamp, 1000);
}
    </script>
  </body>
</html>
