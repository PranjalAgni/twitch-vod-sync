<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Watch multiple Twitch VOD in sync. Useful for competitions."
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Twich VOD Sync</title>
    <style type="text/css">
body {
  margin: 0;
  padding: 0;
  overflow: hidden;
}

div.player {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 20px;
}

div.timestamps {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
}
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="app"></div>
    <form id="picker">
      <input type="text" id="picker-video" placeholder="Twitch video ID">
      <input type="submit" value="Watch">
    </form>
    <div id="player1" class="player"></div>
    <div class="timestamps">
      <div id="timestamp-start"></div>
      <div id="timestamp"></div>
      <div id="timestamp-end"></div>
    </div>
    <script src= "https://player.twitch.tv/js/embed/v1.js"></script>
    <script>
function npad(num, size) {
  var s = "" + num;
  while(s.length < size) {
    s = "0" + s;
  }
  return s;
}

function formatDate(d) {
  return (
    d.getFullYear() + "-"
    + npad(d.getMonth() + 1, 2) + "-"
    + npad(d.getDate(), 2) + " "
    + npad(d.getHours(), 2) + ":"
    + npad(d.getMinutes(), 2) + ":"
    + npad(d.getSeconds(), 2)
  );
}

function parseDuration(s) {
  var m =  s.match(/(?:([0-9]+)h)?([0-9]+)m([0-9]+)s/);
  return (
    parseInt(m[1]) * 3600
    + parseInt(m[2]) * 60
    + parseInt(m[3])
  );
}

// Get an access token for API access
var twitch_client_id = "r69vc9claq1m3n960hrkuszot4nx54";
var access_token = null;
var match = window.location.hash.match(/#access_token=([^&]+)/);
if(match && match[1]) {
  access_token = match[1];
} else {
  window.location = "https://id.twitch.tv/oauth2/authorize?client_id=" + twitch_client_id + "&redirect_uri=https://twitch-sync.remram.fr/&response_type=token&scope=";
}

// Wait for the user to enter a video
document.getElementById("picker").addEventListener("submit", function(evt) {
  evt.preventDefault();
  document.getElementById("picker").style.display = "none";
  showVideo(parseInt(document.getElementById("picker-video").value));
  return false;
});

var interval = null;

function showVideo(video) {
  console.log("video: ", video);
  document.getElementById("player1").style.display = "block";

  // Get video information from API
  var videoDate = null;

  fetch(
    "https://api.twitch.tv/helix/videos?id=" + video,
    {
      headers: {
        "Client-ID": twitch_client_id,
        "Authorization": "Bearer " + access_token,
      },
    },
  ).then(function(response) {
    if(response.status == 200) {
      response.json().then(function(json) {
        var videoInfo = json.data[0];
        console.log("Got video date: ", videoInfo.created_at);
        videoDate = new Date(videoInfo.created_at);
        document.getElementById("timestamp-start").innerText = formatDate(
          videoDate
        );
        document.getElementById("timestamp-end").innerText = formatDate(
          new Date(videoDate.getTime() + parseDuration(videoInfo.duration) * 1000)
        );
      });
    }
  });

  // Create player
  var player = new Twitch.Player("player1", {
    width: "100%",
    height: "100%",
    video: video,
  });

  // Update timestamp when needed
  function updateTimestamp() {
    if(!videoDate) {
      return;
    }
    var timestamp = videoDate;
    timestamp = timestamp.getTime();
    timestamp += player.getCurrentTime() * 1000;
    timestamp = new Date(timestamp);
    document.getElementById("timestamp").innerText = formatDate(timestamp);
  }
  player.addEventListener(Twitch.Player.READY, updateTimestamp);
  player.addEventListener(Twitch.Player.PLAYING, updateTimestamp);
  player.addEventListener(Twitch.Player.PAUSE, updateTimestamp);
  if(interval) {
    clearInterval(interval);
  }
  interval = setInterval(updateTimestamp, 1000);
}
    </script>
  </body>
</html>
